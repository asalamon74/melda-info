<!DOCTYPE html 
     PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
     "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="hu" lang="hu">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Language" content="hu" />
  <title>Focus Stacking</title>
  <link rel="Stylesheet" title="Default Stylesheet"  href="../navi.css" />
  <meta name="keywords"
  content="focus stacking, dof, mélységélesség, Linux" />
  <meta name="viewport" content="width=device-width; initial-scale=1.0;" />
<script type="text/javascript">
function changeImg(cImg,ref) {
document.images[cImg].src = ref
}
</script> 
</head>

<body>
<div class='map'>
  <h2>Tartalomjegyzék</h2>
  <ul>
  <li id='p1'><a href="#bevezetes">1. Bevezetés </a></li>
  <li id='p2'><a href="#technika">2. Technika</a></li>
  <li id='p3'><a href="#illesztes">3. Illesztés</a></li>
  <li id='p4'><a href="#egyesites">4. Egyesítés</a></li>
  <li id='p5'><a href="#youtube">5. Videó</a></li>
  </ul>
</div>

<div class='main'>

<div class='section' id='bevezetes'>

<h1>Focus Stacking</h1>

<p>Makrófotózás során az egyik visszatérő probléma a túl kicsi
  mélységélesség, vagyis az, hogy még a legkisebb rekeszt
  választva sem érjük el, hogy az egész tárgy amit lefényképezünk éles
  legyen.</p>

<p>Példaként egy közgyűrűt fényképeztem le (ez nem túl látványos,
  viszont témába vág) olyan szögből, ahol a közgyűrű érintkezői eltérő
  távolságban vannak a film (szenzor) síkjától.</p>

<p>Az objektíven elérhető legszűkebb rekeszt (22) választva is látszik
  a következő képen ( különösen ha rákattintunk és nagyobb méretben
  kinyitjuk ), hogy bár a középső érintkezők élesek, a hozzánk túl
  közel, vagy túl távol esők életlenek.</p>

<p>
<span class="thumbnail_nosize">
<a href="kozgyuru_22.jpg"><img src="kozgyuru_22_th.jpg" width="300"
			      alt="Közgyűrű 22" /></a>
</span>
</p>
<p style="clear: both">&nbsp;</p>
<p class="comment">Bár a képeket elnézve úgy tűnhet, hogy a
  lefényképezett közgyűrű ütött-kopott és szörnyű állapotban van,
  valójában egy teljesen jól működő darabról van szó, a kisebb karcok
  rajta nem befolyásolják a működését.</p>

<p>A probléma egyik lehetséges megoldása a <em>focus stacking</em> (ha valaki
  tud erre szép magyar kifejezést, kérem írja meg), amikor több
  fényképet készítünk, olyan módon, hogy a fényképeken a tárgy különböző
  részei élesek, majd egy szoftver segítségével a fényképeken
  található éles részeket egyetlen fényképben egyesítjük.</p>
</div>

<div class='section' id='technika'>

<h2>Technikai háttér</h2>

<p>A fényképezés során egy alapobjektívet (SMC Pentax-A 1:2 50mm) és
  56mm vastag közgyűrűt (a közgyűrűsor fényképen nem szereplő másik
  két elemét) használtam, ezzel kb. 1.2:1 nagyítás érhető el. A
  leírtak természetesen ettől lényegében függetlenek, a módszer
  alkalmazható akkor is ha fordítógyűrűt, makróobjektívet használunk.</p>

<p>Összesen 45 fényképet készítettem. A fényképezés során a
  következőket igyekeztem betartani:</p>
<ul>
<li>Állvány használata kötelező.</li>
<li>Lehetőleg teljesen azonos körülmények (pl. fényviszonyok) között
  készüljenek a képek.</li>
<li>Azonos beállításokkal ( ISO, rekesz, idő, fehéregyensúly, ... )
  készüljenek a képek.</li>
<li>A képek a következő beállításokkal készültek: ISO: 200, rekesz: F8,
  idő: 1/4 mp</li>
<li>Az előző sorban szereplő beállításoknál a rekesz tűnhet
  meglepetésnek, hiszen makrófotózásnál többnyire a lehető legszűkebb
  rekeszt szoktuk választani. Mivel most fényképsorozatot készítünk,
  nem feltétlenül kell ehhez ragaszkodni, választhatunk más
  rekeszértéket is. Azért döntöttem F8 mellett, mert az objektív F8
  rekesznél jobb minőséget ad mint F22-nél. (Illene persze ezt
  alaposabban tesztelni.)</li>
<li>A fókusz finom változását nem a fókuszgyűrűvel érhetjük el, hanem
  azzal, hogy a tárgy távolságát fokozatosan változtatjuk. Ezt
  leginkább egy makrosín segítségével érhetjük el.</li>
<li>A fényképek elkészítése során a lehető legkevésbé szabad az
  állványt/fényképezőgépet mozgatni. Laptopról vezérelve a
  fényképezőgépet
  (én &lt;önreklám&gt;<a href="http://pktriggercord.sourceforge.net/">pkTriggerCord</a>&lt;/önreklám&gt;
  programot használtam) ennek csökkenteni lehet az esélyét. A makrosín
  miatt persze szükség van óvatos mozgatásra (mondjuk bizonyára létezik
  számítógépről vezérelhető makrosín is).</li>
<li>A készítendő fényképek számát a mélységélesség határozza
  meg. Fontos, hogy a tárgy minden része legalább 1 képen éles
  legyen, hiszen ha egy pont mindenhol életlen, akkor a végeredményen
  is az lesz. Valójában ennél sűrűbben kell a képeket készíteni,
  hiszen az egymás melletti képek illesztéséhez az kell, hogy kellően
  nagy terület _mindkét_ képen éles legyen.</li>
<li>Bár az objektív és a szenzor tisztán tartása amúgy is ajánlott (és
  kissé reménytelen), itt különösen fontos. A képek kissé eltérő
  nagyítása miatt egy kellően zavaró folt több példányban is
  megjelenik a végső képen.</li>
</ul>

<p>Mind a 45 képet itt nem mutatom meg, 3 jellemző kép:</p>

<p>
<span class="thumbnail_nosize">
<a href="eredeti_frame_00.jpg"><img src="eredeti_frame_th_00.jpg" width="300"
			      alt="Eredeti 00" /></a>
</span>
</p>
<p>
<span class="thumbnail_nosize">
<a href="eredeti_frame_15.jpg"><img src="eredeti_frame_th_15.jpg" width="300"
			      alt="Eredeti 15" /></a>
</span>
</p>
<p>
<span class="thumbnail_nosize">
<a href="eredeti_frame_40.jpg"><img src="eredeti_frame_th_40.jpg" width="300"
			      alt="Eredeti 40" /></a>
</span>
</p>

</div>

<div class='section' id='illesztes'>

<h2>Képek illesztése</h2>

<p>Ha megvizsgáljuk az elkészített képeket, akkor észrevehetjük, hogy
  a lefényképezett tárgy "mozog", nem ugyanazon a helyen van a
  fényképeken. Ahogy egyre közelebb mozdítjuk a fényképezőgépet egyre
  szűkebb a kivágás. Vagyis először is a képeket kell egymáshoz
  illeszteni.</p>

<p>Az illesztést
  az <a href="http://wiki.panotools.org/Align_image_stack">align_image_stack</a>
  program végzi. A program bemenete (a példában <code>kozgyuru_*</code> fájlok) a
  fényképsorozat amit készítettünk, 
  kimenete (a példában <code>ais_kozgyuru*.tif</code>) szintén egy fényképsorozat
  (ugyanannyi képből), ahol a 
  képek kismértékben el vannak mozdítva, át vannak méretezve úgy, hogy
  illeszkedjenek egymásra.</p>

<p>Elméletben a következő parancsra van szükségünk:</p>

<p>
<code class="block">
align_image_stack -m -a ais_kozgyuru_ kozgyuru*.png
</code>
</p>

<p>a gyakorlatban viszont ezzel nem mindig sikerül az illesztés
  (én <code><a href="http://commandline.blog.hu/2010/11/20/feh_1">feh
  -Fd ais*.tif</a></code> segítségével ellenőrzöm ezt) ezért ehelyett ezt
  használtam:</p> 

<p>
<code class="block">
align_image_stack -c 16 -s 2 -m -a ais_kozgyuru_ kozgyuru*.png
</code>
</p>

<p>Némi magyarázat a paraméterekről:</p>
<ul>
<li><code>-m</code>: A kapcsoló hatására a program feltételezi, hogy
  kissé eltérő nagyítással készültek a képek, és az első képet
  leszámítva a többit átméretezi. Esetünkben pont erről van szó, ezért
  focus stackingnél szinte mindig érdemes a kapcsolót használni. Ha
  nem sikerül az illesztés, akkor persze megpróbálhatjuk a kapcsoló
  nélkül is.</li>
<li><code>-c 16</code>: A képek illesztéséhez használt kontrollpontok
  számát módosíthatjuk a paraméterrel. Az alapértelmezés 8, időnként
  nagyobb értéket megadva jobban illeszkednek a képek.</li>
<li><code>-s 2</code>: Megadhatjuk azt, mennyire csökkentse a program a
  képek
  méretét az illesztés során. Az itt megadott paraméter (scale)
  alapján a program 2^scale arányban csökkenti a méretet. A paraméter
  alapértelmezett értéke 1, vagyis alapesetben felére
  csökkenti. Esetünkben a paraméter 2, vagyis negyedére
  csökkentjük. Úgy vettem észre a paraméter főleg akkor segít, ha a
  képeknél elég sok az életlen rész.</li>
</ul>

<p>Biztos van tudományosabb módszer is, én a megfelelő paramétereket sok-sok
  próbálkozással próbáltam megtalálni.</p>

<p>A következő három kép megegyezik a korábban mutatott képekkel, de
  ha az egeret a képek fölé visszuk, átvált az átméretezett
  verzióra (az első képnél nincs átméretezés):</p>

<p>
<span class="thumbnail_nosize">
<a href="illesztett_frame_00.jpg"><img src="eredeti_frame_th_00.jpg"
			      onmouseover="changeImg('ill00','illesztett_frame_th_00.jpg')"
			      onmouseout="changeImg('ill00','eredeti_frame_th_00.jpg')"
			      name="ill00"
			      width="300"
			      alt="Eredeti 00" /></a>
</span>
</p>
<p>
<span class="thumbnail_nosize">
<a href="illesztett_frame_15.jpg"><img src="eredeti_frame_th_15.jpg"
			      onmouseover="changeImg('ill15','illesztett_frame_th_15.jpg')"
			      onmouseout="changeImg('ill15','eredeti_frame_th_15.jpg')"
			      name="ill15"
			      width="300"
			      alt="Eredeti 15" /></a>
</span>
</p>
<p>
<span class="thumbnail_nosize">
<a href="illesztett_frame_40.jpg"><img src="eredeti_frame_th_40.jpg"
			      onmouseover="changeImg('ill40','illesztett_frame_th_40.jpg')"
			      onmouseout="changeImg('ill40','eredeti_frame_th_40.jpg')"
			      name="ill40"
			      width="300"
			      alt="Eredeti 40" /></a>
</span>
</p>

</div>

<div class='section' id='egyesites'>

<h2>Képek egyesítése</h2>

<p>Ha megvan az egymáshoz illesztett képsorozat, akkor egyesíteni kell
  a képeket, vagyis egy olyan képet készíteni, ami minden képből csak
  az éles részeket használja, az életleneket nem. Ehhez
  az <a href="http://enblend.sourceforge.net/">enfuse</a> programot
  használom.</p>

<p class="comment">
A továbbiakban az enfuse 4.0-val foglalkozom, most (2011. február)
még elég sok Linux disztribúcióban csak az enfuse 3.2 érhető
el. Érdemes frissíteni. Az általam használt kapcsolók egy része nem
érhető el enfuse 3.2-nél, másik részét pedig átnevezték.</p>

<p>Itt is van egy elméletben használható parancs:</p>

<p>
<code class="block">
enfuse -o output.tif --exposure-weight=0 --saturation-weight=0 --contrast-weight=1 --hard-mask ais_kozgyuru_*.tif
</code>
</p>

<p>enfuse elég sok szempontot figyelembe tud venni amikor eldönti,
  melyik input fájlból vegye a kép megfelelő részletét. Focus
  stackingnél a kontraszt alapján kell dönteni, ezért állítjuk be
  ennek a súlyát 100%-ra, és a másik két szempont súlyát 0%-ra.</p>

<p>Ezen kívül még szükségünk van a <code>--hard-mask</code>
kapcsolóra, mert enélkül túl lágy lenne a kép.</p>

<p>A konkrét példában ezt a parancsot használtam:</p>

<p>
<code class="block">
enfuse -o output.tif --contrast-edge-scale=0.3 --gray-projector=l-star
--exposure-weight=0 --saturation-weight=0 --contrast-weight=1 --hard-mask  ais_kozgyuru_*.tif
</code>
</p>

<p>Enfuse dokumentációjában olvashatunk a paraméterek jelentéséről, és
  arról milyen értékekkel érdemes tesztelgetni. A paramétereket itt is
  sok teszt alapján próbáltam meghatározni.</p>

<p>A kész képet itt láthatjuk:</p>

<p>
<span class="thumbnail_nosize">
<a href="vegso_frame.jpg"><img src="vegso_frame_th.jpg" width="300"
			      alt="Végső" /></a>
</span>
</p>

<p style="clear: both">&nbsp;</p>

<p>Jól látszik, hogy a kép széle ( különösen a teteje és a jobb oldala
  ) életlen, hiszen ez a rész csak az első képen szerepel a többi
  képen (ahol esetleg éles lenne) már nem. Ezt a részt érdemes
  levágni, én csak azért hagytam a képen, hogy meg tudjam mutatni.</p>

</div>

<div class='section' id='youtube'>

<h2>Demonstrációs videó</h2>

<p>A következő videó megmutaja az eredeti képeket, az illesztett
  képeket, végül a végső eredményt. A képek egymáshoz viszonyított
  elhelyezkedése sokkal jobban látszik a videón, mintha külön-külön
  vizsgálnánk a képeket:</p>

<iframe title="YouTube video player" width="480" height="390" src="http://www.youtube.com/embed/ypFIE85KuVU" frameborder="0"></iframe>
</div>

</div>

<div class="footer">
<p><a href="mailto:andras.salamon@melda.info">Sala</a></p>
<p><a href="http://validator.w3.org/check?uri=referer"><img
style="border: none;" src="http://www.w3.org/Icons/valid-xhtml11"
alt="Valid XHTML 1.1" height="31" width="88" /></a></p>
<!-- BEGIN WebSTAT Activation Code -->
<script type="text/javascript" language="JavaScript" src="http://hits.nextstat.com/cgi-bin/wsv2.cgi?39877"></script>
<noscript>
<a href="http://www.webstat.com">
<img src="http://hits.nextstat.com/scripts/wsb.php?ac=39877" border="0" alt="Website Metrics and Site Statistics by NextSTAT" /></a>
</noscript>
<!-- END WebSTAT Activation Code -->
</div>

</body>
</html>
